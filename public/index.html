<!doctype html>
<title>Bob's chatroom</title>
<script src="//cdn.jsdelivr.net/mithril/0.2.0/mithril.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.3/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/randomcolor/0.1.1/randomColor.min.js"></script>
<script src="/faye/client.js"></script>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
<style>

.chat-wrap {
  width: 700px;
  margin: auto;
  margin-top: 100px;
  padding: 5px;
  padding-bottom: 0;
}

.msg-list-wrap {
  background-color: #EEE;
  padding: 5px;
  width: 100%;
  height: 600px;
  overflow-y: scroll;
}

.msg-list {
  width: 100%;
}

.msg-box {
  width: 100%;
  margin-bottom: 0;
  resize: none;
  font-size: 1.2em;
}

.welcome {
  font-weight: bold;
}

.msg-wrap .panel {
  margin-bottom: 5px;
  width: 500px;
  clear: both;
}

.msg-wrap .well {
  margin-bottom: 5px;
}

.msg-bob {
  font-family: monospace;
}

.msg-private {
  font-style: italic;
}

</style>
<body>
<script>

(function () {

  var persistedToken = window.localStorage.getItem('token')
  var currentUser
  var currentMessages = m.prop([])

  // API services
  var services = (function () {

    function joinChat() {
      return m
        .request({
          method: 'POST',
          url: '/api/users',
          config: configAuth,
          unwrapSuccess: function(response) {
            return response.user
          }
        })
        .then(function (user) {
          currentUser = user
          if(!persistedToken) window.localStorage.setItem('token', user.token)
          sync()
          subscribeToNewMessages()
          waitForUnload()
          return user
        })
    }

    function postMessage(text) {
      return m.request({
        method: 'POST',
        url: '/api/messages',
        config: configAuth,
        data: { message: { text: text } }
      })
    }

    function leaveChat() {
      return m.request({
        method: 'DELETE',
        url: '/api/users',
        config: configAuth
      })
    }

    function sync() {
      getMessageList().then(merge)
    }

    function getMessageList(first) {
      return m.request({
        method: 'GET',
        url: '/api/messages?since=' + lastMessageTime().toISOString(),
        config: configAuth,
        unwrapSuccess: function(response) {
          return response.messages
        }
      })
    }

    function merge(newMessages) {
      var lmt = moment(lastMessageTime())
      var cms = currentMessages()
      newMessages.forEach(function (msg) {
        if(moment(msg.created_at).isAfter(lmt)) cms.push(msg)
      })
      currentMessages(cms)
    }

    function lastMessageTime() {
      var cms = currentMessages()
      return cms.length ?
        moment(cms[cms.length -1].created_at) :
        moment.utc().subtract(10, 'minutes')
    }

    function configAuth(xhr) {
      var token = (currentUser && currentUser.token) || persistedToken
      if(token) {
        xhr.setRequestHeader('Authorization', 'Bearer ' + token)
      }
    }

    function subscribeToNewMessages() {
      var fayeClient = new Faye.Client('/faye')
      fayeClient.subscribe('/public_messages', sync)
      fayeClient.subscribe('/private_messages/' + currentUser.token, sync)
    }

    function waitForUnload() {
      window.onbeforeunload = function () {
        leaveChat()
        return 'Leaving the page will sign you out of chat.'
      }
    }

    return {
      joinChat: joinChat,
      postMessage: postMessage
    }
  })()

  // Display components
  var components = (function () {

    var chatroom = (function () {

      function controller() {
        return {
          welcome:
            'Welcome to the chatroom! You are signed in as ' + currentUser.name,
          messages: currentMessages,
          onkeydown: onkeydown
        }
      }

      function view(ctrl) {
        //console.log(ctrl.messages())
        return m('div.chat-wrap', [
          m('div.welcome', ctrl.welcome),
          m('div.msg-list-wrap', { config: scrollToBottom }, [
            m('div.msg-list', ctrl.messages().map(function (msg) {
              return m.component(message, msg)
            }))
          ]),
          m('textarea.msg-box',
            { autofocus: 1, rows: 3, onkeydown: ctrl.onkeydown }
          )
        ])
      }

      function scrollToBottom(ele) {
        ele.scrollTop = ele.scrollHeight
      }

      function onkeydown(ev) {
        if(ev.keyCode === 13) {
          services.postMessage(ev.target.value)
          ev.target.value = ''
          return false
        }
      }

      return {
        controller: controller,
        view: view
      }
    })()

    // Must be outside the message component
    // so it is shared between all its instances
    var userColors = {} 

    var message = (function () {

      function controller(msg) {
        var isCU = msg.user.id === currentUser.id
        var name = isCU ? 'You' : msg.user.name
        return {
          name: name,
          time: moment(msg.created_at).format('HH:mm:ss'),
          text: msg.text,
          colors: userColors(msg),
          type: msg.type,
          isCU: isCU,
          isPrivate: msg.is_private
        }
      }

      function view(msg) {
        var wrapClass = []
        if(msg.type === 'BobMessage') wrapClass.push('msg-bob')
        if(msg.isPrivate) wrapClass.push('msg-private')
        return m('div.msg-wrap', 
          { class: wrapClass.join(' ') },
          [msgBodyView(msg)]
        )
      }

      function msgBodyView(ctrl) {
        switch(ctrl.type) {
          case 'UserMessage':
          case 'BobMessage':
            return userMsgBodyView(ctrl)
          case 'JoinMessage':
          case 'LeaveMessage':
            return systemMsgBodyView(ctrl)
        }
      }

      function userMsgBodyView(ctrl) {
        var heading = ctrl.name + (ctrl.isPrivate ? ' (private)' : '')
        return m('div.panel.panel-default',
          { style: ctrl.isCU ? { float: 'right' } : {} },
          [
            m('div.panel-heading',
              {
                style: {
                  backgroundColor: ctrl.colors[0],
                  color: ctrl.colors[1]
                }
              },
              heading
            ),
            m('div.panel-body', ctrl.text)
          ]
        )
      }

      function systemMsgBodyView(ctrl) {
        var text =
          ctrl.name + ' ' +
          (ctrl.type === 'JoinMessage' ? 'joined' : 'left') +
          ' the chat'
        return [
          m('div.well.well-sm', text),
        ]
      }

      function userColors(msg) {
        if(msg.type === 'BobMessage') return ['#444', '#fff']
        var id = msg.user.id
        if(id === currentUser.id) return ['#CCC', '#000']
        return [
          userColors[id] || (userColors[id] = newColor()),
          '#000'
        ]
      }

      function newColor() {
        return randomColor({ luminosity: 'light', hue: 'random' })
      }

      return {
        controller: controller,
        view: view
      }
    })()

    return {
      chatroom: chatroom
    }
  })()

  // Bootstrap the app oncce we have a current user
  services.joinChat().then(function () {
    m.mount(document.body, components.chatroom)
  })
})()

</script>