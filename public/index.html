<!doctype html>
<title>Bob's chatroom</title>
<script src="//cdn.jsdelivr.net/mithril/0.2.0/mithril.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.3/moment.min.js"></script>
<script src="/faye/client.js"></script>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
<style>

#chat-wrap {
  width: 700px;
  margin: auto;
  margin-top: 100px;
  padding: 5px;
  padding-bottom: 0;
}

#msg-list {
  background-color: #EEE;
  padding: 5px;
  width: 100%;
  height: 600px;
}

#msg-box {
  width: 100%;
  height: 100px;
  margin-bottom: 0;
  resize: none;
}

.welcome {
  font-weight: bold;
}

.msg-wrap {
  margin-bottom: 3px;
}

.msg-meta {
  width: 200px;
  background-color: #CCC;
  padding: 3px 3px 3px 3px;
}

.msg-user {
  display: inline-block;
  width: 60px;
}

.msg-text {
  font-size: 1.2em;
}

</style>
<body>
<script>

// Our top-level namespace
var chat = {}

// User services
chat.User = {
  joinChat: function () {
    return m
      .request({
        method: 'POST',
        url: '/api/users',
        unwrapSuccess: function(response) {
          return response.user
        }
      })
      .then(function (user) {
        chat.currentUser = user;
      })
  }
}

// Message list model
chat.Messages = m.prop([])

// Message services
chat.Message = {
  sync: function () {
    chat.Message.getList().then(chat.Messages)
  },
  getList: function () {
    var since = moment.utc().subtract(10, 'minutes').toISOString();
    return m.request({
      method: 'GET',
      url: '/api/messages?since=' + since,
      config: chat.Message.configAuth,
      unwrapSuccess: function(response) {
        return response.messages
      }
    })
  },
  post: function (text) {
    return m.request({
      method: 'POST',
      url: '/api/messages',
      config: chat.Message.configAuth,
      data: { message: { text: text } }
    })
  },
  configAuth: function (xhr) {
    xhr.setRequestHeader('Authorization', 'Bearer ' + chat.currentUser.token)
  }
}

// Message list component
chat.MsgList = {
  controller: function () {
    var client = new Faye.Client('/faye')
    client.subscribe('/public_messages', chat.Message.sync)
    client.subscribe(
      '/private_messages/' + chat.currentUser.token,
      chat.Message.sync
    )
    chat.Message.sync()
    return {
      messages: chat.Messages
    }
  },
  view: function (ctrl) {
    return m('div#msg-list',
      ctrl.messages().map(function (msg) {
        return m('div.msg-wrap', [
          m('div.msg-meta', [
            m('span.msg-user', msg.user ? msg.user.name : 'BOB'),
            m('span.msg-time', moment(msg.created_at).format('HH:mm:ss'))
          ]),
          m('span.msg-text', msg.text)
        ])
      })
    )
  }
}

// Message box component
chat.MsgBox = {
  controller: function () {
    return {
      onkeydown: function (ev) {
        if(ev.keyCode === 13) {
          chat.Message.post(ev.target.value)
          ev.target.value = ''
          return false
        }
      }
    }
  },
  view: function (ctrl) {
    return m('textarea', { id: 'msg-box', autofocus: 1, onkeydown: ctrl.onkeydown })
  }
}

// Top-level container component
chat.Container = {
  controller: function () {
    return {
      welcome:
        'Welcome to the chatroom! You are signed in as ' + 
        chat.currentUser.name
    }
  },
  view: function (ctrl) {
    return m('#chat-wrap', [
      m('.welcome', ctrl.welcome),
      m.component(chat.MsgList),
      m.component(chat.MsgBox)
    ])
  }
}

chat.User.joinChat().then(function () {
  m.mount(document.body, chat.Container)
})

</script>